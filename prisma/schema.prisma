generator client {
  provider = "prisma-client-js"
  previewFeatures = ["postgresqlExtensions"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  extensions = [vector]
}
 
model User {
  id            String          @id @default(cuid())
  name          String?
  email         String          @unique
  emailVerified DateTime?
  image         String?
  accounts      Account[]
  sessions      Session[]
  Authenticator Authenticator[]
  repositories      Repository[]
  readmeJobs        ReadmeJob[]
  githubInstallations GitHubInstallation[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}
 
model Account {
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
 
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
 
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
 
  @@id([provider, providerAccountId])
}
 
model Session {
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
 
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}
 
model VerificationToken {
  identifier String
  token      String
  expires    DateTime

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@id([identifier, token])
}
 
model Authenticator {
  credentialID         String  @unique
  userId               String
  providerAccountId    String
  credentialPublicKey  String
  counter              Int
  credentialDeviceType String
  credentialBackedUp   Boolean
  transports           String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@id([userId, credentialID])
}

model GitHubInstallation {
  id                String   @id @default(cuid())
  installationId    Int      @unique
  accountId         Int     
  accountLogin      String  
  accountType       String  
  targetType        String  
  permissions       Json    
  events            String[]
  suspendedAt       DateTime?
  suspendedBy       Int?
  suspendedByLogin  String?
  
  userId            String
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  repositories      Repository[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([installationId])
  @@index([accountLogin])
}

model Repository {
  id                String   @id @default(cuid())
  githubId          Int      @unique
  name              String
  fullName          String  
  owner             String  
  description       String?
  isPrivate         Boolean
  defaultBranch     String
  language          String?
  topics            String[]
  size              Int     
  stargazersCount   Int
  forksCount        Int
  openIssuesCount   Int
  watchersCount     Int
  pushedAt          DateTime?
  githubCreatedAt   DateTime
  githubUpdatedAt   DateTime
  
  userId            String
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  installationId    String
  installation      GitHubInstallation @relation(fields: [installationId], references: [id], onDelete: Cascade)
  readmeJobs        ReadmeJob[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([fullName])
  @@index([owner])
  @@index([language])
}

model ReadmeJob {
  id                String   @id @default(cuid())
  status            JobStatus @default(PENDING)
  progress          Int      @default(0)
  errorMessage      String?
  repositoryId      String
  repository        Repository @relation(fields: [repositoryId], references: [id], onDelete: Cascade)
  includeImages     Boolean  @default(true)
  includeBadges     Boolean  @default(true)
  includeToc        Boolean  @default(true)
  style             String   @default("professional")
  customPrompt      String? 
  startedAt         DateTime?
  completedAt       DateTime?
  processingTime    Int?    
  retryCount        Int      @default(0)
  
  userId            String
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  versions          ReadmeVersion[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status])
  @@index([userId])
  @@index([repositoryId])
}

model ReadmeVersion {
  id                String   @id @default(cuid())
  content           String
  contentHash       String
  wordCount         Int
  characterCount    Int
  modelUsed         String?
  tokensUsed        Int?  
  generationTime    Int?  

  jobId             String
  job               ReadmeJob @relation(fields: [jobId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([jobId])
  @@index([contentHash])
}

enum JobStatus {
  PENDING
  QUEUED
  PROCESSING
  COMPLETED
  FAILED
  CANCELLED
}